"use strict";(()=>{var e={};e.id=3817,e.ids=[3817],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1892:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>g,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>p,staticGenerationAsyncStorage:()=>m});var n={};a.r(n),a.d(n,{GET:()=>d});var s=a(3278),i=a(5002),o=a(4877),r=a(1309),u=a(4738);async function d(e){try{if(console.log("\uD83D\uDCCA Database info request received"),!process.env.DATABASE_URL)return r.NextResponse.json({status:"ERROR",message:"Database not configured",configured:!1,timestamp:new Date().toISOString()},{status:500});let[e,t,a,n,s]=await Promise.all([u._.student.count(),u._.student.count({where:{admis:!0}}),u._.student.findMany({select:{year:!0,examType:!0,admis:!0,moyenne:!0,section:!0,etablissement:!0,wilaya:!0,createdAt:!0,updatedAt:!0}}),u._.dataUpload.findMany({orderBy:{uploadedAt:"desc"}}),u._.student.groupBy({by:["matricule"],_count:!0,having:{matricule:{_count:{gt:1}}}})]),i=e>0?(t/e*100).toFixed(1):"0.0",o=a.reduce((e,t)=>{let a=`${t.examType} ${t.year}`;return e[a]||(e[a]={year:t.year,examType:t.examType,students:[],admittedCount:0,sectionsCount:new Set,establishmentsCount:new Set,wilayasCount:new Set,firstUpload:null,lastUpdate:null}),e[a].students.push(t),t.admis&&e[a].admittedCount++,t.section&&e[a].sectionsCount.add(t.section),t.etablissement&&e[a].establishmentsCount.add(t.etablissement),t.wilaya&&e[a].wilayasCount.add(t.wilaya),(!e[a].firstUpload||t.createdAt<e[a].firstUpload)&&(e[a].firstUpload=t.createdAt),(!e[a].lastUpdate||t.updatedAt>e[a].lastUpdate)&&(e[a].lastUpdate=t.updatedAt),e},{}),d=Object.entries(o).map(([e,t])=>({key:e,year:t.year,examType:t.examType,studentCount:t.students.length,admittedCount:t.admittedCount,admissionRate:t.students.length>0?(t.admittedCount/t.students.length*100).toFixed(1):"0.0",averageScore:t.students.length>0?(t.students.reduce((e,t)=>e+t.moyenne,0)/t.students.length).toFixed(1):0,sectionsCount:t.sectionsCount.size,establishmentsCount:t.establishmentsCount.size,wilayasCount:t.wilayasCount.size,firstUpload:t.firstUpload?.toISOString(),lastUpdate:t.lastUpdate?.toISOString()})),l=await Promise.all(s.slice(0,10).map(async e=>{let t=await u._.student.findMany({where:{matricule:e.matricule},select:{nom_complet:!0}});return{matricule:e.matricule,count:e._count,names:t.map(e=>e.nom_complet)}})),c=new Set(a.map(e=>e.year)).size,m=new Set(a.map(e=>e.examType)).size,p=new Set(a.map(e=>e.section)).size,y=new Set(a.map(e=>e.etablissement)).size,g=new Set(a.map(e=>e.wilaya)).size;return r.NextResponse.json({status:"SUCCESS",message:"Database information retrieved",configured:!0,summary:{totalStudents:e,totalAdmitted:t,admissionRate:i,totalYears:c,totalExamTypes:m,totalSections:p,totalEstablishments:y,totalWilayas:g,tableSize:"N/A",databaseSize:"N/A"},data:d,duplicates:l,environment:{hasDatabase:!0,region:process.env.VERCEL_REGION||"local"},timestamp:new Date().toISOString()})}catch(e){return console.error("❌ Database info error:",e),r.NextResponse.json({status:"ERROR",message:"Failed to retrieve database information",configured:!!process.env.DATABASE_URL,error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/db-info/route",pathname:"/api/admin/db-info",filename:"route",bundlePath:"app/api/admin/db-info/route"},resolvedPagePath:"D:\\WORK\\FREELANCER\\student-result-upgraded\\app\\api\\admin\\db-info\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:p}=l,y="/api/admin/db-info/route";function g(){return(0,o.patchFetch)({serverHooks:p,staticGenerationAsyncStorage:m})}},4738:(e,t,a)=>{a.d(t,{_:()=>i});var n=a(3524);let s=globalThis,i=(()=>{if(process.env.DATABASE_URL)return s.prisma??new n.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}},__internal:{engine:{connectionLimit:5,queryTimeout:15e3,connectionTimeout:5e3,pool:{min:1,max:5,acquireTimeoutMillis:15e3,createTimeoutMillis:15e3,destroyTimeoutMillis:3e3,idleTimeoutMillis:15e3,reapIntervalMillis:500,createRetryIntervalMillis:100}}}})})();i&&process.on("beforeExit",async()=>{try{await Promise.race([i.$disconnect(),new Promise(e=>setTimeout(e,5e3))])}catch(e){console.error("Error disconnecting Prisma:",e)}}),process.on("uncaughtException",async e=>{console.error("Uncaught Exception:",e);try{i&&await i.$disconnect()}catch(e){console.error("Error disconnecting Prisma on uncaught exception:",e)}process.exit(1)})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[9379,4833],()=>a(1892));module.exports=n})();