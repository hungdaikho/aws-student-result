"use strict";(()=>{var e={};e.id=3440,e.ids=[3440],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6302:e=>{e.exports=require("xlsx")},8893:e=>{e.exports=require("buffer")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},2048:e=>{e.exports=require("fs")},629:e=>{e.exports=require("fs/promises")},2615:e=>{e.exports=require("http")},2694:e=>{e.exports=require("http2")},5240:e=>{e.exports=require("https")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},5816:e=>{e.exports=require("process")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},4492:e=>{e.exports=require("node:stream")},1105:(e,o,s)=>{s.r(o),s.d(o,{originalPathname:()=>C,patchFetch:()=>$,requestAsyncStorage:()=>w,routeModule:()=>D,serverHooks:()=>x,staticGenerationAsyncStorage:()=>R});var t={};s.r(t),s.d(t,{POST:()=>f,dynamic:()=>g,maxDuration:()=>h,runtime:()=>m});var r=s(3278),n=s(5002),l=s(4877),a=s(1309),i=s(8893),u=s(3524),d=s(8699);function c(e){return e&&"string"==typeof e?e.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," "):""}let p=new u.PrismaClient,g="force-dynamic",m="nodejs",h=300;async function f(e){try{let o,t;if(console.log("\uD83D\uDE80 Upload API called - Environment:","production"),console.log("\uD83D\uDE80 Runtime:",process.env.VERCEL_REGION||"local"),!process.env.DATABASE_URL)return console.error("‚ùå DATABASE_URL not configured"),a.NextResponse.json({error:"Database not configured. Please configure DATABASE_URL."},{status:500});let r=e.headers.get("content-type");if(console.log("\uD83D\uDCCB Content-Type:",r),!r||!r?.includes("multipart/form-data"))return console.error("‚ùå Invalid content type. Expected multipart/form-data"),a.NextResponse.json({error:"Content-Type must be multipart/form-data for file uploads"},{status:400});let n=await e.formData(),l=n.get("excel"),u=n.get("year"),g=n.get("examType"),m=n.get("columnMapping"),h=n.get("sessionType"),f=n.get("threshold"),D=n.get("wilayaThresholds");if(console.log("\uD83D\uDCCB Form data received:"),console.log("\uD83D\uDCCB File:",l?.name,l?.size,"bytes"),console.log("\uD83D\uDCCB Year:",u),console.log("\uD83D\uDCCB Exam type:",g),console.log("\uD83D\uDCCB Session type:",h),console.log("\uD83D\uDCCB Threshold:",f),console.log("\uD83D\uDCCB Wilaya thresholds:",D),console.log("\uD83D\uDCCB Column mapping:",m),!l)return a.NextResponse.json({error:"No file provided"},{status:400});if(!u||isNaN(Number(u)))return a.NextResponse.json({error:"Invalid year provided"},{status:400});let w=Number(u);if(w<2020||w>2030)return a.NextResponse.json({error:"Year must be between 2020 and 2030"},{status:400});if(!await p.examType.findFirst({where:{code:g,year:w,isActive:!0}}))return a.NextResponse.json({error:`Invalid exam type '${g}' for year ${w}. Please create this exam type first in the admin dashboard.`},{status:400});if(!l.name?.toLowerCase().endsWith(".xlsx")&&!l.name?.toLowerCase().endsWith(".xls"))return a.NextResponse.json({error:"File must be an Excel file (.xlsx or .xls)"},{status:400});if(l.size>52428800)return a.NextResponse.json({error:"File size must be less than 50MB"},{status:400});console.log("‚úÖ Basic validation passed");let R=await l.arrayBuffer(),x=i.Buffer.from(R);console.log("\uD83D\uDCE6 File converted to buffer, size:",x.length,"bytes");let C=await Promise.resolve().then(s.t.bind(s,6302,23));console.log("\uD83D\uDCCA Parsing Excel file...");try{let e=(o=C.read(x,{type:"buffer",cellText:!1,cellDates:!0,cellNF:!1})).SheetNames[0];if(!e)return a.NextResponse.json({error:"Excel file has no sheets"},{status:400});console.log(`üìÑ Processing worksheet: "${e}"`);let s=o.Sheets[e];t=C.utils.sheet_to_json(s,{header:1,raw:!1,dateNF:"YYYY-MM-DD",defval:""}),console.log(`üìä Raw data extracted: ${t.length} rows`)}catch(e){return console.error("‚ùå Excel parsing failed:",e),a.NextResponse.json({error:"Failed to parse Excel file. Please ensure it's a valid Excel file.",details:e.message},{status:400})}if(console.log("\uD83D\uDCCA Raw data rows:",t.length),t.length<2)return a.NextResponse.json({error:"Excel file must have at least a header row and one data row"},{status:400});let $={};if(m)try{$=JSON.parse(m),console.log("\uD83D\uDDFAÔ∏è Using column mapping:",$)}catch(e){return console.error("‚ùå Invalid column mapping JSON:",e),a.NextResponse.json({error:"Invalid column mapping format"},{status:400})}let y=t[0],S=Object.keys($).length>0;console.log("\uD83D\uDCCA Headers:",y),console.log("\uD83D\uDCCA Has mapping:",S);let v={totalRows:t.length-1,processedRows:0,validStudents:0,skippedRows:0,errorRows:0,duplicateRows:0,processingTime:0},N=Date.now(),E=[],b=[],A=new Set,O={},T=(e,o,s)=>{if(S&&$[o]){let s=$[o],t=y.indexOf(s);return t>=0?e[t]:null}return void 0!==s?e[s]:null};for(let e=1;e<t.length;e++){let o=t[e];v.processedRows++;try{if(!o||0===o.length||o.every(e=>!e||""===String(e).trim())){v.skippedRows++,O[e]="SKIPPED: Empty row",console.log(`‚ö†Ô∏è Row ${e+1}: Skipped (completely empty)`);continue}let s=T(o,"matricule",0),t=T(o,"nom_complet",1),r=String(s||"").trim(),n=String(t||"").trim();if(!r){v.errorRows++;let o=`Row ${e+1}: Missing matricule (cell value: "${s}")`;b.push(o),O[e]="ERROR: Missing matricule",console.log(`‚ùå ${o}`);continue}if(!n){v.errorRows++;let o=`Row ${e+1}: Missing nom_complet (cell value: "${t}")`;b.push(o),O[e]="ERROR: Missing nom_complet",console.log(`‚ùå ${o}`);continue}if("CONCOURS"!==g&&A.has(r)){v.duplicateRows++;let o=`Row ${e+1}: Duplicate matricule '${r}' found in file`;b.push(o),O[e]="ERROR: Duplicate matricule",console.log(`‚ùå ${o}`);continue}"CONCOURS"!==g&&A.add(r);let l="",a=0,i=!1;if("CONCOURS"===g){let s=T(o,"score",4),t=0;if(null!=s&&""!==s){let o=String(s).replace(",",".").trim();t=Number.parseFloat(o),isNaN(t)&&(console.warn(`‚ö†Ô∏è Row ${e+1}: Invalid score "${s}", setting to 0`),t=0)}let r=[];if(D)try{r=JSON.parse(D)}catch(e){console.warn(`‚ö†Ô∏è Failed to parse wilaya thresholds: ${e}`)}let n=T(o,"wilaya",9)?String(T(o,"wilaya",9)).trim():void 0,u=f?Number.parseFloat(f):10;if(n&&r.length>0){let e=r.find(e=>e.wilaya.toLowerCase()===n.toLowerCase());e&&(u=e.threshold,console.log(`üéØ CONCOURS: Using wilaya-specific threshold for ${n}: ${u}`))}a=t,l=(i=t>=u)?"Admis":"Ajourn\xe9",console.log(`üéØ CONCOURS: Score ${t} vs Threshold ${u} (${n||"global"}) ‚Üí ${i?"ADMIS":"AJOURN\xc9"}`)}else{l=String(T(o,"decision",7)||"").trim();let s=T(o,"moyenne",4);if(null!=s&&""!==s){let o=String(s).replace(",",".").trim();a=Number.parseFloat(o),isNaN(a)&&(console.warn(`‚ö†Ô∏è Row ${e+1}: Invalid moyenne "${s}", setting to 0`),a=0)}i=function(e){console.log(`üîç Processing decision: "${e}" ‚Üí "${c(e)}"`);let o=function(e){if(!e||"string"!=typeof e)return!1;let o=c(e);return!!(o.includes("admis")||o.includes("reussi")||o.includes("reussie")||o.includes("success")||"r"===o||"a"===o||o.includes("pass")||o.includes("valide"))||!(o.includes("sessionnaire")||o.includes("sessionn")||o.includes("session")||o.includes("rattrapage"))&&(o.includes("echec")||o.includes("echoue")||o.includes("refuse")||o.includes("elimine")||o.includes("ajourne")||o.includes("fail")||o.includes("reject"),!1)}(e);return o?console.log(`‚úÖ Student ADMITTED based on decision: "${c(e)}"`):console.log(`‚ùå Student NOT ADMITTED based on decision: "${c(e)}"`),o}(l)}let u={matricule:r,nom_complet:n,ecole:String(T(o,"ecole",2)||"").trim(),etablissement:String(T(o,"etablissement",3)||"").trim(),moyenne:a,rang:Number(T(o,"rang",5))||0,admis:i,decision_text:l,section:"BREVET"===g?"BREVET":"CONCOURS"===g?"CONCOURS":"EXCELLENCE"===g?"EXCELLENCE":String(T(o,"section",8)||"").trim(),wilaya:T(o,"wilaya",9)?String(T(o,"wilaya",9)).trim():void 0,moughataa:T(o,"moughataa",13)?String(T(o,"moughataa",13)).trim():void 0,rang_etablissement:T(o,"rang_etablissement",10)?Number(T(o,"rang_etablissement",10)):void 0,year:w,examType:g,sessionType:"BAC"===g?h:void 0,lieu_nais:T(o,"lieu_nais",11)?String(T(o,"lieu_nais",11)).trim():void 0,date_naiss:T(o,"date_naiss",12)?String(T(o,"date_naiss",12)).trim():void 0};E.push(u),v.validStudents++,O[e]=`SUCCESS: Student added (${u.admis?"ADMIS":"NOT ADMIS"})`,v.processedRows%1e3==0&&console.log(`üìä Progress: ${v.processedRows}/${v.totalRows} rows processed, ${v.validStudents} valid students`)}catch(s){v.errorRows++;let o=`Row ${e+1}: Error processing row - ${s}`;b.push(o),O[e]=`ERROR: Processing failed - ${s}`,console.error(`‚ùå ${o}`)}}if(v.processingTime=Date.now()-N,console.log(`üìä Processing completed:`),console.log(`üìä Total rows: ${v.totalRows}`),console.log(`üìä Processed rows: ${v.processedRows}`),console.log(`üìä Valid students: ${v.validStudents}`),console.log(`üìä Skipped rows: ${v.skippedRows}`),console.log(`üìä Error rows: ${v.errorRows}`),console.log(`üìä Duplicate rows: ${v.duplicateRows}`),console.log(`üìä Processing time: ${v.processingTime}ms`),0===E.length)return a.NextResponse.json({error:"No valid student records found",details:b.slice(0,10)},{status:400});console.log(`üíæ Storing ${E.length} students in database...`);let B=Date.now();try{let e=Math.ceil(E.length/1e3);console.log(`üì¶ Processing ${E.length} students in ${e} batch(es) of max 1000 each`);let o=0,s=[];for(let t=0;t<e;t++){let r=1e3*t,n=Math.min(r+1e3,E.length),l=E.slice(r,n);console.log(`üì¶ Processing batch ${t+1}/${e} (${l.length} students)...`);try{let e=await d.VT.uploadStudents(l);o+=e.uploadedCount,s.push(...e.errors),console.log(`‚úÖ Batch ${t+1} completed: ${e.uploadedCount} uploaded, ${e.errors.length} errors`)}catch(e){console.error(`‚ùå Batch ${t+1} failed:`,e),s.push(`Batch ${t+1} failed: ${e}`)}}let t={uploadedCount:o,errors:s},r=Date.now();console.log(`‚úÖ Data stored successfully in database - Uploaded: ${t.uploadedCount}, Errors: ${t.errors.length} (took ${((r-B)/1e3).toFixed(2)}s)`),t.errors.length>0&&console.warn(`‚ö†Ô∏è Upload had ${t.errors.length} errors:`,t.errors.slice(0,5));try{let e="BAC"===g&&n.get("sessionType")||null;console.log(`üíæ Saving upload info: ${w}, ${g}, ${l.name}, ${t.uploadedCount}, ${e}`),await d.VT.saveUploadInfo(w,g,l.name,t.uploadedCount,e||void 0),console.log(`‚úÖ Upload info saved successfully`)}catch(e){console.error("‚ùå Failed to save upload info:",e)}let i=E.length,u=E.filter(e=>e.admis).length,c=i>0?(u/i*100).toFixed(1):"0.0",p=i>0?(E.reduce((e,o)=>e+o.moyenne,0)/i).toFixed(2):"0.00",m=[...new Set(E.map(e=>e.section))].filter(Boolean),h=[...new Set(E.map(e=>e.ecole))].filter(Boolean),f=[...new Set(E.map(e=>e.etablissement))].filter(Boolean),D=[...new Set(E.map(e=>e.wilaya))].filter(Boolean);return console.log("\uD83E\uDDF9 Caches will be cleared on next request"),a.NextResponse.json({message:`Successfully processed ${t.uploadedCount} student records for ${g} ${w}`,success:!0,processingStats:v,uploadStats:{uploadedCount:t.uploadedCount,uploadErrors:t.errors.length,processingErrors:b.length},stats:{totalStudents:t.uploadedCount,admittedStudents:u,admissionRate:c,sections:m,schools:h,establishments:f,wilayas:D,averageScore:p},fileInfo:{name:l.name,size:l.size,type:l.type},dbInfo:{stored:!0,year:w,examType:g,uploadedCount:t.uploadedCount,errors:t.errors.length}})}catch(e){return console.error("‚ùå Database error:",e),a.NextResponse.json({error:"Failed to store data in database. Please try again."},{status:500})}}catch(e){return console.error("\uD83D\uDCA5 Upload error:",e),a.NextResponse.json({error:"Internal server error. Please try again."},{status:500})}}let D=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/admin/upload/route",pathname:"/api/admin/upload",filename:"route",bundlePath:"app/api/admin/upload/route"},resolvedPagePath:"D:\\WORK\\FREELANCER\\student-result-upgraded\\app\\api\\admin\\upload\\route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:w,staticGenerationAsyncStorage:R,serverHooks:x}=D,C="/api/admin/upload/route";function $(){return(0,l.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:R})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var s=e=>o(o.s=e),t=o.X(0,[9379,4833,2362,8699],()=>s(1105));module.exports=t})();