"use strict";(()=>{var e={};e.id=791,e.ids=[791],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},618:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>d,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var r={};n.r(r),n.d(r,{GET:()=>c,dynamic:()=>u});var a=n(3278),o=n(5002),i=n(4877),s=n(1309),l=n(4738);let u="force-dynamic";async function c(e){try{let t=e.nextUrl.searchParams,n=t.get("matricule"),r=Number.parseInt(t.get("year")||"2025"),a=t.get("examType")||"BAC",o=t.get("sessionType");if(!n)return s.NextResponse.json({error:"Matricule is required"},{status:400});console.log(`ðŸ† Calculating rankings for matricule: ${n} in ${a} ${r}${o?` (${o})`:""}`);let i=null;if("BAC"===a){if(!o)return s.NextResponse.json({error:"Session type is required for BAC exams. Please specify either 'NORMALE' or 'COMPLEMENTAIRE'",code:"SESSION_REQUIRED"},{status:400});i=await l._.student.findUnique({where:{matricule_year_examType_sessionType:{matricule:n,year:r,examType:a,sessionType:o}}})}else if("CONCOURS"===a){let e=t.get("schoolName"),n=t.get("studentName"),o=t.get("wilaya"),s=t.get("moughataa"),u={year:r,examType:a,sessionType:null};n&&(u.nom_complet=n),e&&(u.etablissement=e),o&&(u.wilaya=o),s&&(u.moughataa=s),i=await l._.student.findFirst({where:u})}else i=await l._.student.findFirst({where:{matricule:n,year:r,examType:a,sessionType:null}});if(!i)return s.NextResponse.json({error:"\xc9tudiant non trouv\xe9"},{status:404});let u=await m(i,r,a);return s.NextResponse.json(u)}catch(e){return console.error("\uD83D\uDCA5 Ranking calculation error:",e),s.NextResponse.json({error:"Internal server error",timestamp:new Date().toISOString()},{status:500})}}async function m(e,t,n){let r={matricule:e.matricule,moyenne:e.moyenne,section:e.section,etablissement:e.etablissement};e.moyenne;let a={year:t,examType:n};if("BAC"===n&&e.sessionType&&(a.sessionType=e.sessionType),"BAC"===n){let o=(await l._.student.findMany({where:{...a,etablissement:e.etablissement,section:e.section}})).sort((e,t)=>{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}),i=1,s=null,u=0;for(let t of o){let n=Math.round(100*t.moyenne)/100;if(null!==s&&n!==s&&(i+=u,u=0),t.matricule===e.matricule){r.schoolRank=i;break}n===s?u++:u=1,s=n}let c=await l._.student.count({where:{year:t,examType:n,etablissement:e.etablissement,section:e.section,...e.sessionType&&{sessionType:e.sessionType}}});r.totalInSchool=c}else{let o=(await l._.student.findMany({where:{...a,etablissement:e.etablissement}})).sort((e,t)=>{if("BREVET"!==n)return t.moyenne-e.moyenne;{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}}),i=1,s=null,u=0;for(let t of o){let a;if(a="BREVET"===n?Math.round(100*t.moyenne)/100:t.moyenne,null!==s&&a!==s&&(i+=u,u=0),t.matricule===e.matricule){r.schoolRank=i;break}a===s?u++:u=1,s=a}let c=await l._.student.count({where:{year:t,examType:n,etablissement:e.etablissement}});r.totalInSchool=c}if(e.wilaya){if("BAC"===n){let o=(await l._.student.findMany({where:{...a,wilaya:e.wilaya,section:e.section}})).sort((e,t)=>{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}),i=1,s=null,u=0;for(let t of o){let n=Math.round(100*t.moyenne)/100;if(null!==s&&n!==s&&(i+=u,u=0),t.matricule===e.matricule){r.wilayaRank=i;break}n===s?u++:u=1,s=n}let c=await l._.student.count({where:{year:t,examType:n,wilaya:e.wilaya,section:e.section,...e.sessionType&&{sessionType:e.sessionType}}});r.totalInWilaya=c}else{let o=(await l._.student.findMany({where:{...a,wilaya:e.wilaya}})).sort((e,t)=>{if("BREVET"!==n)return t.moyenne-e.moyenne;{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}}),i=1,s=null,u=0;for(let t of o){let a;if(a="BREVET"===n?Math.round(100*t.moyenne)/100:t.moyenne,null!==s&&a!==s&&(i+=u,u=0),t.matricule===e.matricule){r.wilayaRank=i;break}a===s?u++:u=1,s=a}let c=await l._.student.count({where:{year:t,examType:n,wilaya:e.wilaya}});r.totalInWilaya=c}}if("BAC"===n){let o=(await l._.student.findMany({where:{...a,section:e.section}})).sort((e,t)=>{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}),i=1,s=null,u=0;for(let t of o){let n=Math.round(100*t.moyenne)/100;if(null!==s&&n!==s&&(i+=u,u=0),t.matricule===e.matricule){r.generalRank=i;break}n===s?u++:u=1,s=n}let c=await l._.student.count({where:{year:t,examType:n,section:e.section,...e.sessionType&&{sessionType:e.sessionType}}});r.totalStudents=c}else{let o=(await l._.student.findMany({where:a})).sort((e,t)=>{if("BREVET"!==n)return t.moyenne-e.moyenne;{let n=Math.round(100*e.moyenne)/100;return Math.round(100*t.moyenne)/100-n}}),i=1,s=null,u=0;for(let t of o){let a;if(a="BREVET"===n?Math.round(100*t.moyenne)/100:t.moyenne,null!==s&&a!==s&&(i+=u,u=0),t.matricule===e.matricule){r.generalRank=i;break}a===s?u++:u=1,s=a}let c=await l._.student.count({where:{year:t,examType:n}});r.totalStudents=c}return r}let y=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ranking/route",pathname:"/api/ranking",filename:"route",bundlePath:"app/api/ranking/route"},resolvedPagePath:"D:\\WORK\\FREELANCER\\student-result-upgraded\\app\\api\\ranking\\route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:p,serverHooks:h}=y,f="/api/ranking/route";function w(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},4738:(e,t,n)=>{n.d(t,{_:()=>o});var r=n(3524);let a=globalThis,o=(()=>{if(process.env.DATABASE_URL)return a.prisma??new r.PrismaClient({log:["error"],datasources:{db:{url:process.env.DATABASE_URL}},__internal:{engine:{connectionLimit:5,queryTimeout:15e3,connectionTimeout:5e3,pool:{min:1,max:5,acquireTimeoutMillis:15e3,createTimeoutMillis:15e3,destroyTimeoutMillis:3e3,idleTimeoutMillis:15e3,reapIntervalMillis:500,createRetryIntervalMillis:100}}}})})();o&&process.on("beforeExit",async()=>{try{await Promise.race([o.$disconnect(),new Promise(e=>setTimeout(e,5e3))])}catch(e){console.error("Error disconnecting Prisma:",e)}}),process.on("uncaughtException",async e=>{console.error("Uncaught Exception:",e);try{o&&await o.$disconnect()}catch(e){console.error("Error disconnecting Prisma on uncaught exception:",e)}process.exit(1)})}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[9379,4833],()=>n(618));module.exports=r})();